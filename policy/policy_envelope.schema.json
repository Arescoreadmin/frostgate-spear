{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://frostgate-spear.io/schemas/policy-envelope.json",
  "title": "Frost Gate Spear Policy Envelope",
  "description": "Policy envelope schema for mission authorization and scope control",
  "type": "object",
  "required": [
    "envelope_id",
    "version",
    "mode",
    "risk_tier",
    "mission_type",
    "classification_level",
    "scope_id",
    "approvals",
    "valid_from",
    "valid_to"
  ],
  "properties": {
    "envelope_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this policy envelope"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version of the policy envelope"
    },
    "mode": {
      "type": "string",
      "enum": ["simulation", "lab", "canary", "production", "mission"],
      "description": "Execution mode for the mission"
    },
    "risk_tier": {
      "type": "integer",
      "minimum": 1,
      "maximum": 3,
      "description": "Risk tier (1=low, 2=medium, 3=high requiring AO approval)"
    },
    "mission_type": {
      "type": "string",
      "enum": [
        "reconnaissance",
        "vulnerability_assessment",
        "penetration_test",
        "red_team",
        "purple_team",
        "adversary_emulation",
        "training",
        "simulation"
      ],
      "description": "Type of mission being authorized"
    },
    "classification_level": {
      "type": "string",
      "enum": ["UNCLASS", "CUI", "SECRET", "TOPSECRET"],
      "description": "Classification level for the mission"
    },
    "scope_id": {
      "type": "string",
      "description": "Reference to the scope definition"
    },
    "scope_hash": {
      "type": "string",
      "pattern": "^sha256:[a-f0-9]{64}$",
      "description": "SHA256 hash of the scope definition for integrity verification"
    },
    "approvals": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Approval"
      },
      "minItems": 1,
      "description": "List of approvals for this policy envelope"
    },
    "budget_cap": {
      "type": "object",
      "properties": {
        "compute_hours": {
          "type": "number",
          "minimum": 0
        },
        "api_calls": {
          "type": "integer",
          "minimum": 0
        },
        "data_transfer_gb": {
          "type": "number",
          "minimum": 0
        },
        "cost_usd": {
          "type": "number",
          "minimum": 0
        },
        "soft_limit_percentage": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "default": 90,
          "description": "Soft throttle at 90% per Blueprint v6.1"
        },
        "hard_limit_percentage": {
          "type": "number",
          "const": 100,
          "description": "Hard stop at 100% per Blueprint v6.1"
        }
      },
      "description": "Budget constraints for the mission"
    },
    "valid_from": {
      "type": "string",
      "format": "date-time",
      "description": "Start of validity period (ISO 8601)"
    },
    "valid_to": {
      "type": "string",
      "format": "date-time",
      "description": "End of validity period (ISO 8601)"
    },
    "roe": {
      "$ref": "#/definitions/RulesOfEngagement"
    },
    "constraints": {
      "$ref": "#/definitions/Constraints"
    },
    "metadata": {
      "type": "object",
      "properties": {
        "created_at": {
          "type": "string",
          "format": "date-time"
        },
        "created_by": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "entrypoints": {
      "type": "array",
      "description": "Multi-entrypoint configuration per Blueprint v6.1 §7",
      "items": {
        "$ref": "#/definitions/EntryPointSpec"
      }
    },
    "entrypoints_required": {
      "type": "integer",
      "minimum": 1,
      "default": 1,
      "description": "Number of entrypoints required"
    },
    "diversity_requirements": {
      "type": "object",
      "description": "Diversity constraints for entrypoints per Blueprint v6.1 §7.1",
      "properties": {
        "require_different_regions": {
          "type": "boolean",
          "default": false
        },
        "require_different_network_zones": {
          "type": "boolean",
          "default": false
        },
        "require_different_asn_classes": {
          "type": "boolean",
          "default": false
        }
      }
    },
    "credential_mode": {
      "type": "string",
      "enum": ["UNAUTHENTICATED", "AUTHENTICATED", "BOTH"],
      "description": "Credential mode per Blueprint v6.1 §7.3"
    },
    "credential_refs": {
      "type": "array",
      "description": "References to vault-managed credential packs (no raw secrets)",
      "items": {
        "type": "object",
        "required": ["credential_pack_id", "vault_ref"],
        "properties": {
          "credential_pack_id": {
            "type": "string"
          },
          "vault_ref": {
            "type": "string",
            "description": "Vault path reference"
          },
          "credential_type": {
            "type": "string",
            "enum": ["API_KEY", "USERNAME_PASSWORD", "CERTIFICATE", "TOKEN", "SSH_KEY"]
          },
          "requires_separate_approval": {
            "type": "boolean",
            "default": false
          }
        }
      }
    },
    "preflight": {
      "type": "object",
      "description": "Stored preflight/blast radius preview output per Blueprint v6.1 §0",
      "properties": {
        "status": {
          "type": "string",
          "enum": ["PASSED", "FAILED", "WARNINGS"]
        },
        "generated_at": {
          "type": "string",
          "format": "date-time"
        },
        "blast_radius_preview": {
          "type": "object",
          "properties": {
            "estimated_targets": { "type": "integer" },
            "estimated_actions": { "type": "integer" },
            "estimated_cost_usd": { "type": "number" }
          }
        },
        "egress_points": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "entrypoint_id": { "type": "string" },
              "egress_ip": { "type": "string" },
              "asn": { "type": "string" }
            }
          }
        }
      }
    },
    "execution_permit_policy": {
      "type": "object",
      "description": "Execution permit policy per Blueprint v6.1 §4.2.3",
      "properties": {
        "ttl_seconds": {
          "type": "integer",
          "minimum": 60,
          "maximum": 86400
        },
        "nonce_strategy": {
          "type": "string",
          "enum": ["SINGLE_USE", "ROLLING", "TIME_BASED"]
        },
        "step_up_requirements": {
          "type": "object",
          "properties": {
            "required_for_modes": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["LIVE_GUARDED", "LIVE_AUTONOMOUS"]
              }
            },
            "method": {
              "type": "string",
              "enum": ["MFA", "BIOMETRIC", "HARDWARE_TOKEN", "DUAL_APPROVAL"]
            }
          }
        }
      }
    },
    "cr_ref": {
      "type": "object",
      "description": "Change request reference (required for non-SIM per Blueprint v6.1 §2.9)",
      "properties": {
        "cr_id": { "type": "string" },
        "approved_at": { "type": "string", "format": "date-time" }
      }
    }
  },
  "definitions": {
    "Approval": {
      "type": "object",
      "required": ["approver_id", "role", "timestamp", "signature"],
      "properties": {
        "approver_id": {
          "type": "string",
          "description": "Unique identifier of the approver"
        },
        "approver_name": {
          "type": "string",
          "description": "Human-readable name of the approver"
        },
        "role": {
          "type": "string",
          "enum": [
            "Product",
            "Security",
            "AO",
            "GovCompliance",
            "Legal",
            "MissionOwner",
            "RedTeamLead",
            "SRE"
          ],
          "description": "Role of the approver"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Time of approval"
        },
        "signature": {
          "type": "string",
          "description": "Base64-encoded cryptographic signature"
        },
        "scope_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "Hash of scope at time of approval"
        },
        "valid": {
          "type": "boolean",
          "default": true
        },
        "expiry": {
          "type": "string",
          "format": "date-time",
          "description": "Expiration time of approval"
        }
      }
    },
    "RulesOfEngagement": {
      "type": "object",
      "properties": {
        "allowed_assets": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of assets explicitly in scope"
        },
        "disallowed_assets": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of assets explicitly out of scope"
        },
        "allowed_networks": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "CIDR ranges in scope"
        },
        "allowed_tools": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Specific tools permitted"
        },
        "allowed_tool_categories": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "reconnaissance",
              "vulnerability_scan",
              "exploitation",
              "credential_access",
              "discovery",
              "lateral_movement",
              "exfiltration",
              "persistence",
              "defense_evasion"
            ]
          },
          "description": "Categories of tools permitted"
        },
        "disallowed_tools": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Specific tools prohibited"
        },
        "time_restrictions": {
          "type": "boolean",
          "default": false,
          "description": "Whether time window restrictions are enforced"
        },
        "alert_footprint_cap": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum number of alerts allowed"
        },
        "blast_radius_cap": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Maximum impact score allowed (0-100)"
        },
        "lateral_movement_authorized": {
          "type": "boolean",
          "default": false,
          "description": "Whether lateral movement is explicitly authorized"
        },
        "lateral_movement_targets": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Specific targets authorized for lateral movement"
        },
        "critical_systems_authorized": {
          "type": "boolean",
          "default": false,
          "description": "Whether targeting critical systems is authorized"
        },
        "destructive_ops_authorized": {
          "type": "boolean",
          "default": false,
          "description": "Whether destructive operations are authorized"
        },
        "data_exfiltration_authorized": {
          "type": "boolean",
          "default": false,
          "description": "Whether data exfiltration (even simulated) is authorized"
        },
        "persistence_authorized": {
          "type": "boolean",
          "default": false,
          "description": "Whether establishing persistence is authorized"
        }
      }
    },
    "Constraints": {
      "type": "object",
      "properties": {
        "max_concurrent_operations": {
          "type": "integer",
          "minimum": 1,
          "default": 5
        },
        "max_attack_depth": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum steps in attack chain"
        },
        "require_human_approval_for": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Action types requiring human approval"
        },
        "simulation_runs_required": {
          "type": "integer",
          "minimum": 0,
          "default": 1000,
          "description": "Number of SIM runs required before promotion"
        },
        "forensic_completeness_threshold": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 0.95,
          "description": "Minimum forensic completeness score"
        }
      }
    },
    "EntryPointSpec": {
      "type": "object",
      "required": ["entrypoint_id", "region", "network_zone"],
      "description": "Entrypoint specification per Blueprint v6.1 §7.1",
      "properties": {
        "entrypoint_id": {
          "type": "string",
          "description": "Unique entrypoint identifier"
        },
        "region": {
          "type": "string",
          "description": "Geographic region"
        },
        "pop": {
          "type": "string",
          "description": "Point of Presence identifier"
        },
        "network_zone": {
          "type": "string",
          "enum": ["PUBLIC", "PRIVATE", "HYBRID", "TOR", "VPN"],
          "description": "Network zone classification"
        },
        "egress_asn": {
          "type": "string",
          "description": "ASN for egress traffic"
        },
        "egress_asn_class": {
          "type": "string",
          "enum": ["RESIDENTIAL", "DATACENTER", "MOBILE", "ENTERPRISE"],
          "description": "Provider egress class"
        },
        "egress_ip_pool_ref": {
          "type": "string",
          "description": "Reference to IP pool for egress"
        },
        "constraints": {
          "type": "object",
          "properties": {
            "max_concurrent_connections": {
              "type": "integer",
              "minimum": 1
            },
            "rate_limit_rps": {
              "type": "integer",
              "minimum": 1
            },
            "allowed_protocols": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["HTTP", "HTTPS", "TCP", "UDP", "SSH", "DNS"]
              }
            }
          }
        }
      }
    },
    "TargetSafetyEnvelope": {
      "type": "object",
      "description": "Target safety envelope per Blueprint v6.1 §8.2",
      "properties": {
        "per_target_rate_limits": {
          "type": "object",
          "additionalProperties": {
            "type": "integer",
            "description": "Max requests per minute per target"
          }
        },
        "stop_conditions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "condition": {
                "type": "string",
                "enum": ["TARGET_HEALTH_DEGRADED", "ERROR_RATE_EXCEEDED", "RESPONSE_TIME_EXCEEDED"]
              },
              "threshold": { "type": "number" },
              "action": {
                "type": "string",
                "enum": ["PAUSE", "STOP", "ALERT"]
              }
            }
          }
        },
        "blast_radius_caps": {
          "type": "object",
          "properties": {
            "max_affected_assets": { "type": "integer" },
            "max_impact_score": { "type": "number", "maximum": 100 }
          }
        },
        "health_probe_gating": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "probe_interval_seconds": { "type": "integer", "default": 30 },
            "failure_threshold": { "type": "integer", "default": 3 }
          }
        }
      }
    }
  }
}
